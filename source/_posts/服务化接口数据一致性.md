---
title: 服务化接口数据一致性
date: 2017-02-03 15:02:29
tags: [业务驱使技术,php,mysql]
category: "业务驱使技术"
---

### A 背景

公司业务不断壮大，玩法也越来越多。
某天，产品开始搞事情，将商家在商家后台的使用的营销工具，活动报名，广告投放，都已改成收费模式。。商家可通过后台直接进行线上充值，然后购买相应的工具。由于工具的种类较多，且后续可能继续延伸，所以将购买消费功能封装成底层接口，统一聚合。

一周之后，线上充值功能和底层消费接口上线。

紧接着产品继续搞事情，业务方开始对接，营销工具的购买。
整体流程简单明了，商家充值 > 购买工具扣除金额 > 增加工具使用时间，记录各种流水。。
关键点，**购买工具扣除金额，同时增加工具使用时间**


### B 构思
充值没大问题，直接使用。

整个流程的关键是要保证扣除金额后，工具的使用时间要增加，保证数据的一致性。
由于扣除金额功能已接口化。。最初是这样：

#### 流程1：
![流程1][1]
  
 显然结果有些炸裂，DB如果执行失败，钱扣了，工具时间没加上...虽说有记录的log，修复太过麻烦 


  
  
#### 流程2：
请教一下同事，有没有好办法，同事给说了个很怪异的方法。。
![流程2][2]

先进行DB操作，然后再调用接口。整个过程如有任何一环失败，进行回滚操作。乍一看确实没什么问题。动手时发现，逻辑出现问题。。
>购买消费时，底层消费接口会记录一条流水。业务方购买成功，也会记录一条业务流水。两者必然需要用某个字段进行关联。。正常的逻辑一定是底层消费流水中某个字段冗余到业务流水中，保证数据一一对应。反过来虽说也可以进行关联，但是显然不太合理。

还有一个问题，虽说遇到的几率很小，但是很致命
>curl请求超时errno = 28，连接超时和执行超时错误代码都是28，连接超时接口一定是没有执行的，不必担心，操作超时就很尴尬了，errno依旧是28，但是请求的接口依旧执行完成。这种情况在流程2里面，还是炸裂的结果，钱扣了，时间没加上。


### C 总结
针对这种边调用接口，边操作DB的问题，要保证数据一致性，建议还是使用具有ACK机制的延迟消费队列。
1.ack机制确保每条消息成功执行
2.延迟消费保证(4个9)不会产生主从延迟。
3.针对金钱问题，consumer接口增加互斥锁(redis、文件锁都可以)，防止重复调用

### 备注

curl请求这个超时问题，区分超时类型有什么好方法呢，难道要使用curl_error()根据超时文案来判断？
针对执行超时的问题，大家可以尝试一下
```php
<?php

$url = 'http://127.0.0.1/test.php';
curl_setopt($ch, CURLOPT_URL, $url);

curl_setopt($ch, CURLOPT_POST, 1);

//php脚本执行超时时间,此处设置1秒
curl_setopt($ch, CURLOPT_TIMEOUT, 1);
//连接服务器响应超时时间
curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 3);

curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

$code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$num = curl_errno($ch);
$msg = curl_error($ch);
echo 'http status code：'.$code.'<br/>';
echo 'curl errno：'.$num.'<br/>';
echo 'curl error msg：'.$msg;
curl_close($ch);



<?php
//test.php
sleep(5);
file_put_contents('test.txt','test');

```


  [1]: http://ogdi895gw.bkt.clouddn.com/flow_20170203_1.png
  [2]: http://ogdi895gw.bkt.clouddn.com/flow_20170203_2.png